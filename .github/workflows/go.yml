name: Go CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    # Expose the final tag (possibly suffixed for PRs) to downstream jobs
    outputs:
      version_tag: ${{ steps.adjust_tag.outputs.tag_name }}

    permissions:
      contents: write   # needed for creating releases

    steps:
      # ───── Setup ────────────────────────────────────────────────────────────
      - name: Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      # ───── Lint / Build / Test ──────────────────────────────────────────────
      - name: Check Go formatting
        run: gofmt -l .

      - name: Build
        run: go build -ldflags "-X 'commands.cliVersion=${{ steps.determine_version.outputs.version_tag }}'" ./...

      - name: Run E2E Tests
        run: go test ./tests/... ./commands/...

      # ───── Versioning & Release ────────────────────────────────────────────
      - name: Determine Next Version
        id: determine_version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          branch: main                           # base branch for SemVer

      # If this run comes from a PR, append a prerelease suffix
      - name: Adjust Tag For PR
        id: adjust_tag
        run: |
          TAG="${{ steps.determine_version.outputs.version_tag }}"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TAG="${TAG}-prerelease.${{ github.run_number }}"
          fi
          echo "tag_name=${TAG}" >>"$GITHUB_OUTPUT"

      - name: Tag and Release
        id: tag_release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const isPrerelease = context.eventName === 'pull_request';
            const tagName      = process.env.TAG_NAME = '${{ steps.adjust_tag.outputs.tag_name }}';
            const releaseName  = `${isPrerelease ? 'Prerelease' : 'Release'} ${tagName}`;

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              tag_name:   tagName,
              name:       releaseName,
              draft:      false,
              prerelease: isPrerelease,
            });

  smoke:
    runs-on: ubuntu-latest
    needs: build

    steps:
      # ───── Setup ────────────────────────────────────────────────────────────
      - name: Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      # ───── Install binary built in previous job ─────────────────────────────
      - name: Install CLI from release tag
        run: |
          go install github.com/wcatron/query-projects@${{ needs.build.outputs.version_tag }}

      # ───── Quick smoke test of the installed CLI ────────────────────────────
      - name: Run smoke tests
        run: |
          export PATH="${PATH}:$(go env GOPATH)/bin"
          cd example
          query-projects info
          query-projects pull
          query-projects run scripts/do-they-have-a-readme.ts
          query-projects run scripts/does-the-project-have-a-linter.ts
          query-projects run scripts/how-activily-maintained-is-the-project.ts
          query-projects run scripts/what-version-of-typescript-is-being-used.ts
          query-projects run scripts/which-test-framework-is-being-used.ts
